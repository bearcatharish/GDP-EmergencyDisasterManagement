<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
<head>
    <title>Reports</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="hands.ico" />
    <link rel="stylesheet" href="css/bootstrap.min.css">         
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="css/style.css" />
    <!-- Material Design Bootstrap -->
    <link href="css/mdb.min.css" rel="stylesheet">
    <script type="text/javascript" src="js/jquery-2.2.3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>      
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-filter/0.5.8/angular-filter.min.js"></script>

    <!--Google Maps-->
    <script src="https://maps.google.com/maps/api/js"></script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBy9oLNr1SQzUHSrIZuazYjsbtZIxL6B3c&callback=initMap">
</script>

<!--        CDN Link for generating PDF files-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.debug.js"></script>

<!-- Bootstrap tooltips -->
<script type="text/javascript" src="js/tether.min.js"></script>

<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="js/bootstrap.min.js"></script>

<!-- MDB core JavaScript -->
<script type="text/javascript" src="js/mdb.min.js"></script>
<link rel="stylesheet" href="http://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css"></style>
<script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>

</head>
<body>
    <div ng-app="myApp" ng-controller="myCtrl">
        <table>
            <td>
                <img src="CERT Logo.jpg" name="image" height="150" width="500"/>
            </td>
        </tr>
    </table>
    <nav class="navbar navbar-dark mdb-color">
        <div class="container-fluid">
                    <!--<div class="navbar-header">
                      <ul class="nav navbar-nav">
                    <!--<div class="container">
        
                    <!--Collapse content-->
                    <div class="collapse navbar-toggleable-xs" id="collapseEx">
                        <!--Navbar Brand-->
                        <!--Links-->
                        <ul class="nav navbar-nav">
                            <li class="nav-item"><a href="/Home">Home</a></li>
                            <li class="nav-item active"><a href="/Reports">Reports</a></li>
                            <li class="nav-item"><a href="/Volunteers">Volunteers</a></li>
                            <li class="nav-item"> <a href="/Groups">Groups</a></li> 
                            <li class="nav-item"><a href=aboutUs.html>About Us</a></li> 
                            <li class="nav-item"><a href=FAQ.html>FAQ's</a></li> 
                        </ul>

                        <form action ="/logout">
                         <button class="btn btn-primary btn-sm" style="float: right" type="submit">Logout</button> 
                     </form>
                 </div>     
             </div>
         </nav>       

         <div class="container">

            <div class="row"><br>
                <form class="form-inline" role="search">
                    <div class="md-form form-group">
                        <h2><strong> <%= JSON.stringify(incidentName) %> Reports</strong> &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
                            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
                            <input type="text" class="form-control" ng-model="test" placeholder="Search">
                            
                            <button class="btn btn-default" type="submit"><i class="fa fa-search"></i></button>                                                      
                        </h2>


                    </div><br>

                </form>

                <div class="col-md-12 filterable" >
                    <div class="table-responsive">                           
                        <table id="mytable" class="table table-bordered table-striped table">
                            <thead class="thead-inverse">
                                <tr class="filters">
                                    <th>Location</th>
                                    <th>Incident name </th>
                                    <th>Level Of Impact <br>
                                        <select>
                                            <option></option>
                                            <option ng-repeat="x in reports | unique: 'levelOfImpact'">{{x.levelOfImpact}}</option>
                                    <!-- <option>Low</option>
                                    <option>Medium</option>
                                    <option>High</option> -->
                                </select>
                            </th>
                            <th>Reported by</th>

                            <th>Cell Number</th>
                            <!-- <th> Date </th> -->
                            <th>Edit</th>
                            <th>Delete</th>
                            <th>Full Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="x in reports| filter:test">

                            <!-- <td>
                                <div ng-hide="editingData[x.id]" ng-bind="x.location"></div>
                                <div ng-show="editingData[x.id]"><input type="text" ng-model="x.location" /></div>
                            </td> -->
                            <td> <button data-toggle="modal" data-target="#mapView"><i class="fa fa-map-marker" aria-hidden="true"></i></button></td>
                            <td>
                                <div ng-hide="editingData[x.id]" ng-bind="x.incidentName"></div>
                                <div ng-show="editingData[x.id]"><input type="text" ng-model="x.incidentName" /></div>
                            </td>
                            <td>
                                <div ng-hide="editingData[x.id]" ng-bind="x.levelOfImpact"></div>
                                <div ng-show="editingData[x.id]"><input type="text" ng-model="x.levelOfImpact" /></div>
                            </td>
                            <td>
                                <div ng-hide="editingData[x.id]" ng-bind="x.userName"></div>
                                <div ng-show="editingData[x.id]"><input type="text" ng-model="x.userName" /></div>
                            </td>

                            <td> 
                                <div ng-hide="editingData[x.id]" ng-bind="x.contactNo"></div>
                                <div ng-show="editingData[x.id]"><input type="text" ng-model="x.contactNo" /></div>
                            </td>
                           <!--  <td>
                                <div ng-hide="editingData[x._id]" ng-bind="x.createdAt"></div>
                                <div ng-show="editingData[x._id]"><input type="Date" ng-model="x.createdAt" /></div>
                            </td> -->

                            <td>
                                <button ng-hide="editingData[x.id]" ng-click="modify(x)" class="btn btn-primary btn-sm"><span class="fa fa-pencil"></span></button>
                                <button ng-show="editingData[x.id]" ng-click="update(x)" class="btn btn-warning btn-sm"><span class="fa fa-check-square"></span>Update</button>
                            </td>
                            <td>   <button ng-hide="viewField" class="btn btn-danger btn-sm" ng-click="delete(x)"><span class="fa fa-trash"></span></button>
                            </td>
                            <td class="detail_td">
                                <p data-placement="top" data-toggle="tooltip" title="Details">
                                    <!-- detail button to display full details -->
                                    <button class="detail_button btn btn-primary btn-xs dtlBtn" id="{{x._id}}" data-title="Details" data-toggle="modal" data-target="#orderDetails">Detail
                                    </button>
                                </p>
                            </td>
                        </tr>                            



                    </tbody>
                </table>                            
            </div>
            <div id ="hide" style="display:none"></div>
            <div class="modal fade" id="orderDetails" tabindex="-1" role="dialog" aria-labelledby="createGroup" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Report Details</h3>
                        </div>
                        <div class="modal-body">
                            <div id="rowDetails">
                                <span>

                                </span>
                            </div>
                        </div>
                        <div class="modal-footer ">
                            <button type="button" class="detail_button btn btn-primary btn-xs dtlBtn" data-dismiss="modal" aria-hidden="true" id="savePdf">Save as PDF</button>
                            <button type="button" class="detail_button btn btn-primary btn-xs dtlBtn" data-dismiss="modal" aria-hidden="true">Close</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!--                report pop up div -->
    <div id="orderModal" class="modal hide fade" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
            <h3>Order</h3>

        </div>
        <div id="orderDetails" class="modal-body"></div>
        <div id="orderItems" class="modal-body"></div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        </div>
    </div>
    <div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="fa fa-times" aria-hidden="true"></span></button>
                    <h4 class="modal-title custom_align" id="Heading">Delete this entry</h4>
                </div>
                <div class="modal-body">

                    <div class="alert alert-warning"><span class="glyphicon glyphicon-warning-sign"></span> Are you sure you want to delete this Record?</div>

                </div>
                <div class="modal-footer ">
                    <button type="button" class="btn btn-success glyphicon glyphicon-remove row-remove" id="yesBtn" ><span class="fa fa-check"></span>Yes</button>
                    <button type="button" class="btn btn-warning" data-dismiss="modal"><span class="fa fa-remove"></span>No</button>
                </div>
            </div>
            <!-- /.modal-content --> 
        </div>
        <!-- /.modal-dialog --> 
    </div>
</div>
</div>
<div class="modal fade" id="mapView" tabindex="-1" role="dialog" aria-labelledby="mapView" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="fa fa-times" aria-hidden="true"></span></button>
                <h4 class="modal-title custom_align" id="Heading">Location</h4>                    
            </div>
            <div class="modal-body">
             <div id="map-container" class="z-depth-1" style="height: 350px;width: 570px"></div>   
         </div> 
         <div class="modal-footer ">
         </div>  
         <!-- /.modal-content --> 
     </div>

     <!-- /.modal-dialog --> 
 </div>
            <!--<div class="modal fade" id="create" tabindex="-1" role="dialog" aria-labelledby="create" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="fa fa-times" aria-hidden="true"></span></button>
                            <h4 class="modal-title custom_align" id="Heading">Report Details</h4>
                        </div>
                        <form action="/viewReport" method="post">
                            <div class="modal-body">
                                
                            </div>
                            <div class="modal-footer ">
                                <a href="./report.html"><button>Cancel</button></a>
                                <button type="submit" class="btn btn-success btn-lg" style="width: 100%;"><span class="fa fa-check-square"></span>�Download</button>
                            </div>
                        </form>
                    </div>
                    <!-- /.modal-content --> 
                <!--</div>

                <!-- /.modal-dialog --> 
                <!--</div>-->
                <!-- <script>
                    function init_map() {

                        var var_location = new google.maps.LatLng(40.725118, -73.997699);

                        var var_mapoptions = {
                            center: var_location,

                            zoom: 14
                        };

                        var var_marker = new google.maps.Marker({
                            position: var_location,
                            map: var_map,
                            title: "New York"
                        });

                        var var_map = new google.maps.Map(document.getElementById("map-container"),
                            var_mapoptions);

                        var_marker.setMap(var_map);

                    }

                    google.maps.event.addDomListener(window, 'load', init_map);
                </script> -->

                <script>
                    var reports = []
                    var app = angular.module('myApp', ['angular.filter']);
                    app.controller('myCtrl', ['$scope', '$http', '$window', function ($scope, $http, $location) {
                        $scope.reports = <%- JSON.stringify(vol) %>;
                        reports = $scope.reports;
                   // console.log(reports);
                   $scope.editingData = {};

                   for (var i = 0, length = $scope.reports.length; i < length; i++) {
                    $scope.editingData[$scope.reports[i].id] = false;
                    
                }


                $scope.modify = function (x) {
                    $scope.editingData[x._id] = true;
                };

                $scope.delete = function(x){
                    var _id = x._id;
                    return $http({method: 'POST',
                        url: '/deleteReport',
                        data: JSON.stringify({
                            _id: x._id
                        }),
                        headers: {
                         'Content-Type': 'application/json'
                     }
                 }).success(function (response) {
                                             window.location='/Reports';  
                                             
                                         });
                };
                $scope.update = function (x) {
                    var _id = x._id;
                    $http({method: 'POST',
                       url: '/updateReport',
                       data: JSON.stringify({
                        _id: x._id,
                        location: x.location,
                        incidentName: x.incidentName,
                        levelOfImpact: x.levelOfImpact,
                        userName: x.userName,
                        mobileNumber: x.mobileNumber
                        // createdAt: x.createdAt
                    }),
                       headers: {
                           'Content-Type': 'application/json'
                       }
                   });
                    $scope.editingData[x._id] = false;
                };
            }]);</script>
                    <script>function init_map() {

                        var var_location = new google.maps.LatLng(40.3507, -94.8824);

                        var var_mapoptions = {
                            center: var_location,

                            zoom: 14
                        };

                        var var_marker = new google.maps.Marker({
                            position: var_location,
                            map: var_map,
                            title: "New York"
                        });

                        var var_map = new google.maps.Map(document.getElementById("map-container"),
                            var_mapoptions);

                        var_marker.setMap(var_map);

                    }
                    google.maps.event.addDomListener(window, 'click', init_map);
                    // document.getElementById("map-container").innerHTML = init_map();</script>
                    <script>$(document).ready(function () {
                       $('#mytable').dataTable(
                           { "bFilter": false, 
                           "ordering": false,
                           "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ] });

                       $("#mytable #checkall").click(function () {
                        if ($("#mytable #checkall").is(':checked')) {
                            $("#mytable input[type=checkbox]").each(function () {
                                $(this).prop("checked", true);
                            });

                        } else {
                            $("#mytable input[type=checkbox]").each(function () {
                                $(this).prop("checked", false);
                            });
                        }


                        $("[data-toggle=tooltip]").tooltip();
                    });
                       $('#yesBtn').click(function() {
                        // handle deletion here
                       // print("Hello");
                       // var id = $('.confrimDelete').data('title');
//                        var id = 'John';
//                        $('[data-reportedBy='+id+']').parents('tr').remove();
//                        $('#delete').modal('hide');
var id = $('.confrimDelete').data('id');
$('[data-id='+id+']').parents('tr').remove();
$('#myModal').modal('hide');
});
                       $(".dtlBtn").on("click", function (evt) {
                        console.log(evt);
                        var row_id = evt.target.id;



                        var slctdRow = {}
                        reports.forEach(function(row){
                            if(row._id==row_id){
                                slctdRow = row
                            }
                        });

                        var formHtml = "<form >";

                        for( key in slctdRow){
                            if( (key != "_id" && key != "_created_at" && key != "$$hashKey" && key != "_updated_at" ))
                                formHtml += '<div class="form-group"><label for="exampleInputEmail1" class="dtl_key">'+key+': </label> <span id="'+key+'" class="dtl_value" > '+slctdRow[key]+'</span></div>';
                        }

                        formHtml += "" 
                        formHtml += "</form>"

                        $('#rowDetails').html(formHtml);
                    });

                       var name, volunteerComments, uName,greenVic, blackVic,lvlOfImpact, yellowVic, redVic, mobilenum;
                       $('.detail_button').click(function(){

                        id = $('#incidentName').html();
                        comments = $('#comments').html();
                        userName = $('#userName').html();
                        greenVictims = $('#greenVictims').html();
                        blackVictims = $('#blackVictims').html();
                        levelOfImpact = $('#levelOfImpact').html();
                        yellowVictims = $('#yellowVictims').html();
                        redVictims = $('#redVictims').html();
                        mobileNumber = $('#mobileNumber').html();




                        localStorage.setItem('name',id);
                        localStorage.setItem('volunteerComments',comments);
                        localStorage.setItem('uName', userName);
                        localStorage.setItem('greenVic',greenVictims);
                        localStorage.setItem('blackVic',blackVictims);
                        localStorage.setItem('lvlOfImpact',levelOfImpact);
                        localStorage.setItem('yellowVic',yellowVictims);
                        localStorage.setItem('redVic',redVictims);
                        localStorage.setItem('mobilenum',mobileNumber);



                        name = localStorage.getItem('name');
                        volunteerComments = localStorage.getItem('volunteerComments');
                        uName = localStorage.getItem('uName');
                        greenVic = localStorage.getItem('greenVic');
                        blackVic = localStorage.getItem('blackVic');
                        lvlOfImpact = localStorage.getItem('lvlOfImpact');
                        yellowVic = localStorage.getItem('yellowVic');
                        redVic = localStorage.getItem('redVic');
                        mobilenum = localStorage.getItem('mobilenum');

                        $('#savePdf').data('whichid', id);
                        $('#savePdf').data('volComments',comments);
                        $( '#savePdf').data('usrName', userName);
                        $( '#savePdf').data('grnVic', greenVictims);
                        $( '#savePdf').data('blckVic', blackVictims);
                        $( '#savePdf').data('lvlImpct', levelOfImpact);
                        $( '#savePdf').data('ylwVic',yellowVictims);
                        $( '#savePdf').data('rdVic', redVictims);
                        $( '#savePdf').data('mNum', mobileNumber);

                    });


                       name = localStorage.getItem('name');
                       volunteerComments = localStorage.getItem('volunteerComments');
                       uName = localStorage.getItem('uName');
                       greenVic = localStorage.getItem('greenVic');
                       blackVic = localStorage.getItem('blackVic');
                       lvlOfImpact = localStorage.getItem('lvlOfImpact');
                       yellowVic = localStorage.getItem('yellowVic');
                       redVic = localStorage.getItem('redVic');
                       mobilenum = localStorage.getItem('mobilenum');


//generating a PDF
$('#savePdf').click(function () {
   // var a = id;
   var a  = $('#savePdf').data('whichid');
   var b = $('#savePdf').data('volComments');
   var c = $('#savePdf').data('usrName');
   var d = $('#savePdf').data('grnVic');
   var e = $('#savePdf').data('blckVic');
   var f = $('#savePdf').data('lvlImpct');
   var g = $('#savePdf').data('ylwVic');
   var h = $('#savePdf').data('rdVic');
   var i = $('#savePdf').data('mNum');



  //   var lMargin=15; //left margin in mm
   // var rMargin=15; //right margin in mm
    //var pdfInMM=210;  // width of A4 in mm
    var doc = new jsPDF();


    doc.text(80, 10, 'Report Details ' );
    doc.text(10, 20, 'Id : ' + a );
    
    doc.text(10, 30, 'User Name:' + c);
    doc.text(10, 40, 'Green Victims:' + d);
    doc.text(10, 50, 'Black Victims:' + e);
    doc.text(10,60, 'Level Of Impact:' + f);
    doc.text(10,70, 'Yellow Victims:' + g);
    doc.text(10,80, 'Red Victims:' + h);
    doc.text(10,90, 'Mobile Number:' + i);

    doc.text(10, 100, 'Comments: ' +b);


    doc.save('Reports.pdf');

});



$('.filterable .filters select').change(function(e){
    /* Ignore tab key */
    /* Useful DOM data and selectors */
    var $input = $(this),
    inputContent = $input.val(),
    $panel = $input.parents('.filterable'),
    column = $panel.find('.filters th').index($input.parents('th')),
    $table = $panel.find('.table'),
    $rows = $table.find('tbody tr');
    /* Dirtiest filter function ever ;) */
    var $filteredRows = $rows.filter(function(){
        var value = $(this).find('td').eq(column).text();
        return value.indexOf(inputContent) === -1;
    });

    /* Clean previous no-result if exist */
    $table.find('tbody .no-result').remove();
    /* Show all rows, hide filtered ones (never do that outside of a demo ! xD) */
    $rows.show();

    $filteredRows.hide();
    /* Prepend no-result row if all rows are filtered */
    if ($filteredRows.length === $rows.length) {
        $table.find('tbody').prepend($('<tr class="no-result text-center"><td colspan="'+ $table.find('.filters th').length +'">No result found</td></tr>'));
    }
});    

});

</script>

</body>
</html>
